#!/bin/sh 
#Time to wait until the next twiddle loop
SLEEP_TIME=<%=opts[:sleep_time]%>

SERVER='<%= twiddle.jboss_server %>'
USER='<%= twiddle.jmx_user %>'
PASSWORD='<%= twiddle.jmx_password %>'

#Resources

CONNECTORS=(<%= monitor.resources[:connector].join ' ' %>)
DATASOURCES=(<%= monitor.resources[:datasource].join ' ' %>)
WEBAPPS=(<%= monitor.resources[:webapp].join ' ' %>)

#Path to twiddle
<%= opts[:twiddle_command_var] %>="<%= "#{twiddle.jboss_home}" %>/bin/twiddle.sh -s $SERVER -u '$USER' -p '$PASSWORD'"

while [ 1 ] ; do
  clear
  echo ">>> Starting monitoring for server <%=twiddle.jboss_host %> <<<"

  echo " "
  echo ">>> Server Info "
  <% @monitor.properties[:server_info].each do |property| %>
    echo " |---> $(<%= monitor.server_info[property] %>)"
  <% end %>
  echo " "
  echo ">>> Connectors"
  <% monitor.resources[:connector].each do |resource| %>
    <% monitor.with resource do %>
      echo " |---> <%= resource %>"
      <% monitor.properties[:connector].each do |property| %>
        echo "   |---> $(<%= monitor.connector[property] %>)"
      <% end %>
      <% monitor.properties[:request].each do |property| %>
        echo "   |---> $(<%= monitor.request[property] %>)"
      <% end %>
    <% end %>
    echo " "
  <% end %>
  echo " "
  echo ">>> Datasources"
  <% monitor.resources[:datasource].each do |resource| %>
    <% monitor.with resource do %>
      echo " |---> <%= resource %>"
      <% monitor.properties[:datasource].each do |property| %>
        echo "   |---> $(<%= monitor.datasource[property] %>)"
      <% end %>
    <% end %>
    echo " "
  <% end %>
  echo ">>> Webapps"
  <% monitor.resources[:webapp].each do |resource| %>
    <% monitor.with resource do %>
      echo " |---> <%= resource %>"
      <% monitor.properties[:webapp].each do |property| %>
        echo "   |---> $(<%= monitor.webapp[property] %>)"
      <% end %>
    <% end %>
    echo " "
  <% end %>
  sleep $SLEEP_TIME
done

